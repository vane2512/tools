<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logo æŠ å›¾å·¥å…·</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #f8fafc;
      --bg-secondary: #fff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --accent-color: #6366f1;
      --accent-hover: #4f46e5;
      --success-color: #10b981;
      --danger-color: #ef4444;
    }

    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
      --accent-color: #818cf8;
      --accent-hover: #6366f1;
      --success-color: #34d399;
      --danger-color: #f87171;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    .container { max-width: 1200px; margin: 0 auto; position: relative; }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 20px;
      transition: color 0.2s;
      font-weight: 500;
    }
    .back-link:hover { color: var(--accent-color); }

    .theme-toggle {
      position: absolute;
      top: 0;
      right: 0;
      width: 44px;
      height: 44px;
      border: none;
      background: var(--bg-secondary);
      border-radius: 12px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border-color);
      transition: all 0.3s;
      z-index: 100;
    }
    .theme-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    }
    .theme-toggle .icon-sun { display: none; }
    .theme-toggle .icon-moon { display: block; }
    [data-theme="dark"] .theme-toggle .icon-sun { display: block; }
    [data-theme="dark"] .theme-toggle .icon-moon { display: none; }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      color: var(--text-primary);
    }
    .upload-area {
      border: 3px dashed var(--accent-color);
      border-radius: 16px;
      padding: 60px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--bg-secondary);
      margin-bottom: 30px;
    }
    .upload-area:hover { border-color: var(--accent-hover); background: rgba(99, 102, 241, 0.1); }
    .upload-icon { font-size: 64px; margin-bottom: 16px; }
    .upload-text { font-size: 18px; color: var(--text-secondary); }
    #fileInput { display: none; }

    .image-list {
      display: none;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      min-height: 80px;
      align-items: center;
    }
    .image-list.visible {
      display: flex;
    }
    .thumb-item {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid var(--border-color);
      transition: all 0.2s;
    }
    .thumb-item:hover { transform: scale(1.05); }
    .thumb-item.active { border-color: var(--accent-color); box-shadow: 0 0 10px rgba(99, 102, 241, 0.15); }
    .thumb-item.processed::after {
      content: 'âœ“';
      position: absolute;
      top: 2px;
      right: 2px;
      background: var(--success-color);
      color: #fff;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .thumb-item img { width: 100%; height: 100%; object-fit: cover; }
    .thumb-item .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      background: var(--danger-color);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .thumb-item:hover .remove-btn { display: flex; }
    .add-more-btn {
      width: 60px;
      height: 60px;
      border: 2px dashed var(--accent-color);
      border-radius: 8px;
      background: transparent;
      color: var(--accent-color);
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .add-more-btn:hover { background: rgba(99, 102, 241, 0.05); }

    .controls {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
      display: none;
    }
    .controls.visible { display: block; }
    .control-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .control-group label {
      font-size: 14px;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    input[type="range"] { width: 120px; accent-color: var(--accent-color); }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    .btn-primary {
      background: var(--accent-color);
      color: #fff;
    }
    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.15);
    }
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    .btn-secondary:hover { background: var(--bg-primary); border-color: var(--border-color); }
    .btn-success {
      background: var(--success-color);
      color: #fff;
    }
    .btn-success:hover {
      background: var(--success-color);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.15);
    }
    .canvas-container {
      display: none;
      gap: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .canvas-container.visible { display: flex; }
    .canvas-wrapper { text-align: center; }
    .canvas-wrapper h3 { margin-bottom: 16px; font-size: 16px; color: var(--text-secondary); }
    .canvas-box {
      background:
        linear-gradient(45deg, var(--border-color) 25%, transparent 25%),
        linear-gradient(-45deg, var(--border-color) 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, var(--border-color) 75%),
        linear-gradient(-45deg, transparent 75%, var(--border-color) 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      background-color: var(--bg-primary);
      border-radius: 12px;
      padding: 20px;
      display: inline-block;
      border: 1px solid var(--border-color);
    }
    canvas {
      max-width: 400px;
      max-height: 400px;
      border-radius: 8px;
      cursor: crosshair;
    }
    .tolerance-value {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      color: #6366f1;
    }
    .mode-switch {
      display: flex;
      gap: 4px;
      background: var(--bg-primary);
      padding: 4px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    .mode-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .mode-btn.active {
      background: #6366f1;
      color: #fff;
    }
    .hint-box {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      color: #059669;
    }
    .brush-cursor {
      position: fixed;
      border: 2px solid #10b981;
      border-radius: 50%;
      pointer-events: none;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(16, 185, 129, 0.15);
      display: none;
    }
    .brush-cursor.eraser {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.15);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body { padding: 12px; }
      h1 { font-size: 22px; margin-bottom: 20px; }
      .upload-area { padding: 40px 15px; }
      .upload-icon { font-size: 48px; }
      .upload-text { font-size: 14px; }
      .controls { padding: 16px; }
      .control-row { gap: 12px; }
      .control-group { flex-wrap: wrap; gap: 8px; }
      .control-group label { min-width: auto; font-size: 13px; }
      input[type="range"] { width: 100px; }
      .btn { padding: 10px 16px; font-size: 13px; }
      .canvas-container { gap: 20px; }
      .canvas-wrapper h3 { font-size: 14px; }
      canvas { max-width: 100%; max-height: 300px; }
      .mode-switch { flex-wrap: wrap; }
      .mode-btn { padding: 6px 12px; font-size: 12px; }
      .thumb-item { width: 50px; height: 50px; }
      .add-more-btn { width: 50px; height: 50px; }
    }

    @media (max-width: 480px) {
      .control-row { flex-direction: column; align-items: flex-start; gap: 10px; }
      .control-group { width: 100%; justify-content: space-between; }
      input[type="range"] { flex: 1; }
      .btn { width: 100%; margin-bottom: 8px; }
      .canvas-container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
      <span class="icon-sun">â˜€ï¸</span>
      <span class="icon-moon">ğŸŒ™</span>
    </button>
    <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
    <h1>ğŸ¨ Logo æŠ å›¾å·¥å…·</h1>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
      <input type="file" id="fileInput" accept="image/*" multiple>
    </div>

    <div class="image-list" id="imageList"></div>

    <div class="controls" id="controls">
      <div class="control-row">
        <div class="hint-box" id="hintBox">
          <strong>æ­¥éª¤1ï¼š</strong>ç‚¹å‡»èƒŒæ™¯è‰²ç§»é™¤èƒŒæ™¯
        </div>
      </div>

      <div class="control-row">
        <div class="control-group">
          <label>å®¹å·®å€¼ï¼š</label>
          <input type="range" id="tolerance" min="10" max="100" value="30">
          <span class="tolerance-value" id="toleranceValue">30</span>
        </div>
        <div class="control-group">
          <label>ç¾½åŒ–ï¼š</label>
          <input type="range" id="feather" min="0" max="5" value="1">
          <span class="tolerance-value" id="featherValue">1</span>
        </div>
      </div>

      <div class="control-row" id="brushRow" style="display: none;">
        <div class="control-group">
          <label>ç”»ç¬”å¤§å°ï¼š</label>
          <input type="range" id="brushSize" min="5" max="100" value="20">
          <span class="tolerance-value" id="brushSizeValue">20</span>
        </div>
        <div class="control-group">
          <label>å·¥å…·ï¼š</label>
          <div class="mode-switch">
            <button class="mode-btn active" id="brushToolBtn">ğŸ–Œï¸ æ¢å¤</button>
            <button class="mode-btn" id="eraserToolBtn">ğŸ§¹ æ“¦é™¤</button>
          </div>
        </div>
      </div>

      <div class="control-row">
        <button class="btn btn-secondary" id="undoBtn" disabled>â†©ï¸ æ’¤é”€</button>
        <button class="btn btn-secondary" id="redoBtn" disabled>â†ªï¸ é‡åš</button>
        <button class="btn btn-secondary" id="resetBtn">ğŸ”„ é‡ç½®</button>
        <button class="btn btn-primary" id="enableBrushBtn" style="display: none;">ğŸ–Œï¸ ç”»ç¬”ä¿®å¤</button>
        <button class="btn btn-success" id="downloadBtn">ğŸ’¾ ä¸‹è½½ PNG</button>
        <button class="btn btn-success" id="downloadAllBtn" style="display: none;">ğŸ“¦ ä¸‹è½½å…¨éƒ¨</button>
      </div>
    </div>

    <div class="canvas-container" id="canvasContainer">
      <div class="canvas-wrapper">
        <h3 id="canvasTitle">åŸå›¾ï¼ˆç‚¹å‡»èƒŒæ™¯è‰²ï¼‰</h3>
        <div class="canvas-box">
          <canvas id="originalCanvas"></canvas>
        </div>
      </div>
      <div class="canvas-wrapper">
        <h3>å¤„ç†ç»“æœ</h3>
        <div class="canvas-box">
          <canvas id="resultCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="brush-cursor" id="brushCursor"></div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const controls = document.getElementById('controls');
    const canvasContainer = document.getElementById('canvasContainer');
    const originalCanvas = document.getElementById('originalCanvas');
    const resultCanvas = document.getElementById('resultCanvas');
    const tolerance = document.getElementById('tolerance');
    const toleranceValue = document.getElementById('toleranceValue');
    const feather = document.getElementById('feather');
    const featherValue = document.getElementById('featherValue');
    const brushSize = document.getElementById('brushSize');
    const brushSizeValue = document.getElementById('brushSizeValue');
    const resetBtn = document.getElementById('resetBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const enableBrushBtn = document.getElementById('enableBrushBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const brushRow = document.getElementById('brushRow');
    const hintBox = document.getElementById('hintBox');
    const canvasTitle = document.getElementById('canvasTitle');
    const brushToolBtn = document.getElementById('brushToolBtn');
    const eraserToolBtn = document.getElementById('eraserToolBtn');
    const brushCursor = document.getElementById('brushCursor');
    const imageList = document.getElementById('imageList');

    const originalCtx = originalCanvas.getContext('2d');
    const resultCtx = resultCanvas.getContext('2d');

    let originalImageData = null;
    let resultImageData = null;  // å½“å‰å¤„ç†åçš„å›¾åƒæ•°æ®
    let brushMode = false;
    let isDrawing = false;
    let currentTool = 'brush'; // 'brush' or 'eraser'

    // å†å²è®°å½•
    let historyStack = [];
    let redoStack = [];
    const MAX_HISTORY = 30;

    // æ‰¹é‡å›¾ç‰‡ç®¡ç†
    let imageStore = [];  // { id, name, thumbnail, originalImageData, resultImageData, historyStack, redoStack, brushMode }
    let currentImageId = null;

    // ä¿å­˜çŠ¶æ€åˆ°å†å²è®°å½•
    function saveState() {
      if (!resultImageData) return;
      // å¤åˆ¶å½“å‰çŠ¶æ€
      const stateCopy = new ImageData(
        new Uint8ClampedArray(resultImageData.data),
        resultImageData.width,
        resultImageData.height
      );
      historyStack.push(stateCopy);
      if (historyStack.length > MAX_HISTORY) {
        historyStack.shift();
      }
      redoStack = []; // æ¸…ç©ºé‡åšæ ˆ
      updateUndoRedoButtons();
    }

    // æ’¤é”€
    function undo() {
      if (historyStack.length === 0) return;
      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°é‡åšæ ˆ
      const currentState = new ImageData(
        new Uint8ClampedArray(resultImageData.data),
        resultImageData.width,
        resultImageData.height
      );
      redoStack.push(currentState);

      // æ¢å¤ä¸Šä¸€ä¸ªçŠ¶æ€
      const prevState = historyStack.pop();
      resultImageData = prevState;
      resultCtx.putImageData(resultImageData, 0, 0);
      updateUndoRedoButtons();
    }

    // é‡åš
    function redo() {
      if (redoStack.length === 0) return;
      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²æ ˆ
      const currentState = new ImageData(
        new Uint8ClampedArray(resultImageData.data),
        resultImageData.width,
        resultImageData.height
      );
      historyStack.push(currentState);

      // æ¢å¤é‡åšçŠ¶æ€
      const nextState = redoStack.pop();
      resultImageData = nextState;
      resultCtx.putImageData(resultImageData, 0, 0);
      updateUndoRedoButtons();
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    function updateUndoRedoButtons() {
      undoBtn.disabled = historyStack.length === 0;
      redoBtn.disabled = redoStack.length === 0;
    }

    undoBtn.addEventListener('click', undo);
    redoBtn.addEventListener('click', redo);

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
        e.preventDefault();
        if (e.shiftKey) {
          redo();
        } else {
          undo();
        }
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
        e.preventDefault();
        redo();
      }
    });

    // ä¸Šä¼ 
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      if (files.length) loadImages(files);
    });
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length) loadImages(files);
      e.target.value = ''; // å…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
    });

    // æ‰¹é‡åŠ è½½å›¾ç‰‡
    function loadImages(files) {
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const id = Date.now() + Math.random();
            const maxSize = 600;
            let w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
              if (w > h) { h = (h / w) * maxSize; w = maxSize; }
              else { w = (w / h) * maxSize; h = maxSize; }
            }

            // åˆ›å»ºä¸´æ—¶canvasè·å–å›¾åƒæ•°æ®
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(img, 0, 0, w, h);
            const imgData = tempCtx.getImageData(0, 0, w, h);

            // åˆ›å»ºç¼©ç•¥å›¾
            const thumbCanvas = document.createElement('canvas');
            thumbCanvas.width = 60;
            thumbCanvas.height = 60;
            const thumbCtx = thumbCanvas.getContext('2d');
            const scale = Math.max(60 / w, 60 / h);
            const sw = w * scale, sh = h * scale;
            thumbCtx.drawImage(img, (60 - sw) / 2, (60 - sh) / 2, sw, sh);
            const thumbnail = thumbCanvas.toDataURL('image/png');

            // å­˜å‚¨å›¾ç‰‡æ•°æ®
            const imageItem = {
              id,
              name: file.name,
              thumbnail,
              originalImageData: imgData,
              resultImageData: null,
              historyStack: [],
              redoStack: [],
              brushMode: false,
              width: w,
              height: h
            };
            imageStore.push(imageItem);

            renderImageList();

            // è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€å¼ å›¾ç‰‡
            if (imageStore.length === 1) {
              switchToImage(id);
            }
            updateDownloadAllBtn();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
    function renderImageList() {
      imageList.innerHTML = '';

      if (imageStore.length === 0) {
        imageList.classList.remove('visible');
        return;
      }

      imageList.classList.add('visible');
      imageStore.forEach(item => {
        const thumb = document.createElement('div');
        thumb.className = 'thumb-item' + (item.id === currentImageId ? ' active' : '') + (item.resultImageData ? ' processed' : '');
        thumb.innerHTML = `
          <img src="${item.thumbnail}" alt="${item.name}" title="${item.name}">
          <button class="remove-btn" title="åˆ é™¤">Ã—</button>
        `;
        thumb.querySelector('img').addEventListener('click', () => switchToImage(item.id));
        thumb.querySelector('.remove-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          removeImage(item.id);
        });
        imageList.appendChild(thumb);
      });

      // æ·»åŠ "æ·»åŠ æ›´å¤š"æŒ‰é’®
      if (imageStore.length > 0) {
        const addBtn = document.createElement('button');
        addBtn.className = 'add-more-btn';
        addBtn.textContent = '+';
        addBtn.title = 'æ·»åŠ æ›´å¤šå›¾ç‰‡';
        addBtn.addEventListener('click', () => fileInput.click());
        imageList.appendChild(addBtn);
      }
    }

    // åˆ‡æ¢åˆ°æŒ‡å®šå›¾ç‰‡
    function switchToImage(id) {
      // ä¿å­˜å½“å‰å›¾ç‰‡çŠ¶æ€
      if (currentImageId !== null) {
        const currentItem = imageStore.find(item => item.id === currentImageId);
        if (currentItem) {
          currentItem.resultImageData = resultImageData;
          currentItem.historyStack = [...historyStack];
          currentItem.redoStack = [...redoStack];
          currentItem.brushMode = brushMode;
        }
      }

      // åŠ è½½æ–°å›¾ç‰‡
      const newItem = imageStore.find(item => item.id === id);
      if (!newItem) return;

      currentImageId = id;
      originalImageData = newItem.originalImageData;
      resultImageData = newItem.resultImageData;
      historyStack = [...newItem.historyStack];
      redoStack = [...newItem.redoStack];
      brushMode = newItem.brushMode;

      // è®¾ç½®ç”»å¸ƒå¤§å°
      originalCanvas.width = resultCanvas.width = newItem.width;
      originalCanvas.height = resultCanvas.height = newItem.height;

      // ç»˜åˆ¶å›¾åƒ
      originalCtx.putImageData(originalImageData, 0, 0);
      if (resultImageData) {
        resultCtx.putImageData(resultImageData, 0, 0);
      } else {
        resultCtx.putImageData(originalImageData, 0, 0);
      }

      // æ¢å¤UIçŠ¶æ€
      if (brushMode) {
        brushRow.style.display = 'flex';
        enableBrushBtn.style.display = 'none';
        hintBox.innerHTML = 'ğŸ–Œï¸ <strong>æ¢å¤</strong>ï¼šæ¶‚æŠ¹æ¢å¤è¯¯åˆ åŒºåŸŸ | ğŸ§¹ <strong>æ“¦é™¤</strong>ï¼šæ¶‚æŠ¹åˆ é™¤å¤šä½™åŒºåŸŸ';
        canvasTitle.textContent = 'åŸå›¾ï¼ˆæ¶‚æŠ¹ä¿®å¤ï¼‰';
        originalCanvas.style.cursor = 'none';
        resultCanvas.style.cursor = 'none';
      } else if (resultImageData) {
        brushRow.style.display = 'none';
        enableBrushBtn.style.display = 'inline-block';
        hintBox.innerHTML = '<strong>æ­¥éª¤2ï¼š</strong>ç‚¹å‡»ã€Œç”»ç¬”ä¿®å¤ã€æ¢å¤è¯¯åˆ çš„åŒºåŸŸ';
        canvasTitle.textContent = 'åŸå›¾ï¼ˆç‚¹å‡»èƒŒæ™¯è‰²ï¼‰';
        originalCanvas.style.cursor = 'crosshair';
        resultCanvas.style.cursor = 'crosshair';
      } else {
        brushRow.style.display = 'none';
        enableBrushBtn.style.display = 'none';
        hintBox.innerHTML = '<strong>æ­¥éª¤1ï¼š</strong>ç‚¹å‡»èƒŒæ™¯è‰²ç§»é™¤èƒŒæ™¯';
        canvasTitle.textContent = 'åŸå›¾ï¼ˆç‚¹å‡»èƒŒæ™¯è‰²ï¼‰';
        originalCanvas.style.cursor = 'crosshair';
        resultCanvas.style.cursor = 'crosshair';
      }

      updateUndoRedoButtons();
      controls.classList.add('visible');
      canvasContainer.classList.add('visible');
      renderImageList();
    }

    // åˆ é™¤å›¾ç‰‡
    function removeImage(id) {
      const index = imageStore.findIndex(item => item.id === id);
      if (index === -1) return;

      imageStore.splice(index, 1);

      if (imageStore.length === 0) {
        // æ²¡æœ‰å›¾ç‰‡äº†ï¼Œé‡ç½®ç•Œé¢
        currentImageId = null;
        originalImageData = null;
        resultImageData = null;
        historyStack = [];
        redoStack = [];
        brushMode = false;
        controls.classList.remove('visible');
        canvasContainer.classList.remove('visible');
      } else if (currentImageId === id) {
        // å½“å‰å›¾ç‰‡è¢«åˆ é™¤ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€å¼ æˆ–ä¸Šä¸€å¼ 
        const newIndex = Math.min(index, imageStore.length - 1);
        switchToImage(imageStore[newIndex].id);
      }

      renderImageList();
      updateDownloadAllBtn();
    }

    // æ›´æ–°ä¸‹è½½å…¨éƒ¨æŒ‰é’®
    function updateDownloadAllBtn() {
      const processedCount = imageStore.filter(item => item.resultImageData).length;
      downloadAllBtn.style.display = processedCount > 1 ? 'inline-block' : 'none';
    }

    // ç‚¹å‡»ç§»é™¤èƒŒæ™¯ / ç”»ç¬”æ“ä½œï¼ˆä¸¤ä¸ªç”»å¸ƒéƒ½æ”¯æŒï¼‰
    originalCanvas.addEventListener('mousedown', handleCanvasMouseDown);
    originalCanvas.addEventListener('mousemove', handleCanvasMouseMove);
    originalCanvas.addEventListener('mouseup', handleMouseUp);
    originalCanvas.addEventListener('mouseleave', handleMouseLeave);
    originalCanvas.addEventListener('mouseenter', handleMouseEnter);

    resultCanvas.addEventListener('mousedown', handleCanvasMouseDown);
    resultCanvas.addEventListener('mousemove', handleCanvasMouseMove);
    resultCanvas.addEventListener('mouseup', handleMouseUp);
    resultCanvas.addEventListener('mouseleave', handleMouseLeave);
    resultCanvas.addEventListener('mouseenter', handleMouseEnter);

    function handleMouseEnter() {
      if (brushMode) brushCursor.style.display = 'block';
    }

    function handleMouseLeave() {
      brushCursor.style.display = 'none';
      if (isDrawing) {
        isDrawing = false;
        saveState(); // ä¿å­˜ç”»ç¬”æ“ä½œ
      }
    }

    function handleMouseUp() {
      if (isDrawing) {
        isDrawing = false;
        saveState(); // ä¿å­˜ç”»ç¬”æ“ä½œ
      }
    }

    function handleCanvasMouseDown(e) {
      if (!originalImageData) return;
      const {x, y} = getCanvasCoords(e, e.target);

      if (brushMode) {
        isDrawing = true;
        paint(x, y);
      } else {
        removeBackground(x, y);
      }
    }

    function handleCanvasMouseMove(e) {
      if (brushMode) {
        updateBrushCursor(e);
        if (isDrawing) {
          const {x, y} = getCanvasCoords(e, e.target);
          paint(x, y);
        }
      }
    }

    function getCanvasCoords(e, canvas) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return {
        x: Math.floor((e.clientX - rect.left) * scaleX),
        y: Math.floor((e.clientY - rect.top) * scaleY)
      };
    }

    // ç§»é™¤èƒŒæ™¯è‰²
    function removeBackground(clickX, clickY) {
      const w = originalCanvas.width, h = originalCanvas.height;
      const src = originalImageData.data;
      const idx = (clickY * w + clickX) * 4;
      const targetColor = { r: src[idx], g: src[idx+1], b: src[idx+2] };

      const tol = parseInt(tolerance.value) * 4.41;
      const feath = parseInt(feather.value);
      const newData = resultCtx.createImageData(w, h);
      const dst = newData.data;

      for (let i = 0; i < src.length; i += 4) {
        const diff = Math.sqrt(
          (src[i] - targetColor.r) ** 2 +
          (src[i+1] - targetColor.g) ** 2 +
          (src[i+2] - targetColor.b) ** 2
        );

        dst[i] = src[i];
        dst[i+1] = src[i+1];
        dst[i+2] = src[i+2];

        if (diff < tol) {
          if (feath > 0) {
            const ft = tol * (1 - feath / 10);
            dst[i+3] = diff < ft ? 0 : Math.round(((diff - ft) / (tol - ft)) * 255);
          } else {
            dst[i+3] = 0;
          }
        } else {
          dst[i+3] = 255;
        }
      }

      resultCtx.putImageData(newData, 0, 0);
      resultImageData = newData;
      saveState(); // ä¿å­˜ç§»é™¤èƒŒæ™¯æ“ä½œ

      // æ›´æ–° imageStore
      const currentItem = imageStore.find(item => item.id === currentImageId);
      if (currentItem) {
        currentItem.resultImageData = resultImageData;
        renderImageList(); // æ›´æ–°processedçŠ¶æ€
        updateDownloadAllBtn();
      }

      // æ˜¾ç¤ºç”»ç¬”æŒ‰é’®
      enableBrushBtn.style.display = 'inline-block';
      hintBox.innerHTML = '<strong>æ­¥éª¤2ï¼š</strong>ç‚¹å‡»ã€Œç”»ç¬”ä¿®å¤ã€æ¢å¤è¯¯åˆ çš„åŒºåŸŸ';
    }

    // å¯ç”¨ç”»ç¬”æ¨¡å¼
    enableBrushBtn.addEventListener('click', () => {
      brushMode = true;
      brushRow.style.display = 'flex';
      enableBrushBtn.style.display = 'none';
      hintBox.innerHTML = 'ğŸ–Œï¸ <strong>æ¢å¤</strong>ï¼šæ¶‚æŠ¹æ¢å¤è¯¯åˆ åŒºåŸŸ | ğŸ§¹ <strong>æ“¦é™¤</strong>ï¼šæ¶‚æŠ¹åˆ é™¤å¤šä½™åŒºåŸŸ';
      canvasTitle.textContent = 'åŸå›¾ï¼ˆæ¶‚æŠ¹ä¿®å¤ï¼‰';
      originalCanvas.style.cursor = 'none';
      resultCanvas.style.cursor = 'none';

      // åŒæ­¥åˆ°imageStore
      const currentItem = imageStore.find(item => item.id === currentImageId);
      if (currentItem) currentItem.brushMode = true;
    });

    // å·¥å…·åˆ‡æ¢
    brushToolBtn.addEventListener('click', () => {
      currentTool = 'brush';
      brushToolBtn.classList.add('active');
      eraserToolBtn.classList.remove('active');
      brushCursor.classList.remove('eraser');
    });
    eraserToolBtn.addEventListener('click', () => {
      currentTool = 'eraser';
      eraserToolBtn.classList.add('active');
      brushToolBtn.classList.remove('active');
      brushCursor.classList.add('eraser');
    });

    // ç”»ç¬”å…‰æ ‡
    function updateBrushCursor(e) {
      const size = parseInt(brushSize.value) * 2;
      brushCursor.style.width = size + 'px';
      brushCursor.style.height = size + 'px';
      brushCursor.style.left = e.clientX + 'px';
      brushCursor.style.top = e.clientY + 'px';
      brushCursor.style.display = 'block';
    }

    // ç»˜åˆ¶
    function paint(cx, cy) {
      if (!resultImageData) return;
      const w = originalCanvas.width, h = originalCanvas.height;
      const radius = parseInt(brushSize.value);
      const src = originalImageData.data;
      const dst = resultImageData.data;

      for (let dy = -radius; dy <= radius; dy++) {
        for (let dx = -radius; dx <= radius; dx++) {
          if (dx*dx + dy*dy <= radius*radius) {
            const px = cx + dx, py = cy + dy;
            if (px >= 0 && px < w && py >= 0 && py < h) {
              const i = (py * w + px) * 4;
              if (currentTool === 'brush') {
                dst[i+3] = 255; // æ¢å¤
              } else {
                dst[i+3] = 0;   // æ“¦é™¤
              }
            }
          }
        }
      }
      resultCtx.putImageData(resultImageData, 0, 0);
    }

    // ç”»ç¬”å¤§å°
    brushSize.addEventListener('input', (e) => {
      brushSizeValue.textContent = e.target.value;
    });

    // å®¹å·®/ç¾½åŒ–å˜åŒ–
    tolerance.addEventListener('input', (e) => toleranceValue.textContent = e.target.value);
    feather.addEventListener('input', (e) => featherValue.textContent = e.target.value);

    // é‡ç½®
    resetBtn.addEventListener('click', () => {
      if (originalImageData) {
        resultCtx.putImageData(originalImageData, 0, 0);
        resultImageData = null;
        brushMode = false;
        brushRow.style.display = 'none';
        enableBrushBtn.style.display = 'none';
        hintBox.innerHTML = '<strong>æ­¥éª¤1ï¼š</strong>ç‚¹å‡»èƒŒæ™¯è‰²ç§»é™¤èƒŒæ™¯';
        canvasTitle.textContent = 'åŸå›¾ï¼ˆç‚¹å‡»èƒŒæ™¯è‰²ï¼‰';
        originalCanvas.style.cursor = 'crosshair';
        resultCanvas.style.cursor = 'crosshair';
        brushCursor.style.display = 'none';
        historyStack = [];
        redoStack = [];
        updateUndoRedoButtons();

        // åŒæ­¥åˆ°imageStore
        const currentItem = imageStore.find(item => item.id === currentImageId);
        if (currentItem) {
          currentItem.resultImageData = null;
          currentItem.historyStack = [];
          currentItem.redoStack = [];
          currentItem.brushMode = false;
          renderImageList();
          updateDownloadAllBtn();
        }
      }
    });

    // ä¸‹è½½å½“å‰å›¾ç‰‡
    downloadBtn.addEventListener('click', () => {
      const currentItem = imageStore.find(item => item.id === currentImageId);
      const fileName = currentItem ? currentItem.name.replace(/\.[^/.]+$/, '') + '-extracted.png' : 'extracted-image.png';
      const link = document.createElement('a');
      link.download = fileName;
      link.href = resultCanvas.toDataURL('image/png');
      link.click();
    });

    // ä¸‹è½½å…¨éƒ¨å¤„ç†åçš„å›¾ç‰‡
    downloadAllBtn.addEventListener('click', async () => {
      const processedItems = imageStore.filter(item => item.resultImageData);
      if (processedItems.length === 0) return;

      // é€ä¸ªä¸‹è½½
      for (let i = 0; i < processedItems.length; i++) {
        const item = processedItems[i];
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = item.width;
        tempCanvas.height = item.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(item.resultImageData, 0, 0);

        const fileName = item.name.replace(/\.[^/.]+$/, '') + '-extracted.png';
        const link = document.createElement('a');
        link.download = fileName;
        link.href = tempCanvas.toDataURL('image/png');
        link.click();

        // é—´éš”ä¸€ä¸‹é¿å…æµè§ˆå™¨é™åˆ¶
        if (i < processedItems.length - 1) {
          await new Promise(r => setTimeout(r, 300));
        }
      }
    });

    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
      html.setAttribute('data-theme', 'dark');
    }
    themeToggle.addEventListener('click', () => {
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      if (newTheme === 'dark') {
        html.setAttribute('data-theme', 'dark');
      } else {
        html.removeAttribute('data-theme');
      }
      localStorage.setItem('theme', newTheme);
    });
  </script>
</body>
</html>
