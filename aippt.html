<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIPPT - AIæ™ºèƒ½PPTç”Ÿæˆå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #fff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-color: #6366f1;
            --accent-hover: #4f46e5;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --accent-color: #818cf8;
            --accent-hover: #6366f1;
            --success-color: #34d399;
            --danger-color: #f87171;
            --warning-color: #fbbf24;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        .container { max-width: 1400px; margin: 0 auto; position: relative; }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
            transition: color 0.2s;
            font-weight: 500;
        }
        .back-link:hover { color: var(--accent-color); }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            width: 44px;
            height: 44px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            z-index: 100;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }
        .theme-toggle .icon-sun { display: none; }
        .theme-toggle .icon-moon { display: block; }
        [data-theme="dark"] .theme-toggle .icon-sun { display: block; }
        [data-theme="dark"] .theme-toggle .icon-moon { display: none; }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            color: var(--text-primary);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .main-layout { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
        }

        .tab {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--accent-color);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--border-color);
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 30px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:hover {
            border-color: var(--accent-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-upload .icon { font-size: 36px; margin-bottom: 8px; }
        .file-upload p { color: var(--text-secondary); font-size: 14px; }
        .file-upload .formats { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .file-upload input { display: none; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-block { width: 100%; }

        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .template-card {
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .template-card:hover { border-color: var(--accent-color); }
        .template-card.active { border-color: var(--accent-color); background: rgba(99, 102, 241, 0.1); }

        .template-preview {
            height: 40px;
            border-radius: 4px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .template-card .name { font-size: 11px; color: var(--text-secondary); }

        /* Color Grid */
        .color-grid {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover { transform: scale(1.1); }
        .color-option.active { border-color: var(--text-primary); }

        /* Export Buttons */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .export-btn {
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .export-btn:hover:not(:disabled) {
            background: var(--border-color);
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Preview Area */
        .preview-panel {
            min-height: 500px;
        }

        .slides-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .slide-wrapper { position: relative; }

        .slide-number {
            position: absolute;
            top: -8px;
            left: 16px;
            background: var(--accent-color);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .slide {
            width: 100%;
            aspect-ratio: 16/9;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .slide-content {
            width: 100%;
            height: 100%;
            padding: 32px 40px;
            color: #1a1a2e;
            display: flex;
            flex-direction: column;
        }

        .slide-cover {
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .slide-cover h1 { font-size: 2.2rem; margin-bottom: 12px; }
        .slide-cover .subtitle { font-size: 1.1rem; opacity: 0.8; }

        .slide-content-page h2 {
            font-size: 1.5rem;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 3px solid;
        }

        .slide-content-page .points {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 12px;
        }

        .slide-content-page .point {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 1rem;
        }

        .slide-content-page .point-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .slide-chart h2 { font-size: 1.5rem; margin-bottom: 16px; }
        .chart-container { flex: 1; display: flex; align-items: center; justify-content: center; }

        .slide-table table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        .slide-table th, .slide-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #e0e0e0; }

        .timeline { display: flex; justify-content: space-between; margin-top: 32px; position: relative; }
        .timeline::before { content: ''; position: absolute; top: 16px; left: 0; right: 0; height: 3px; background: #e0e0e0; }
        .timeline-item { flex: 1; text-align: center; position: relative; padding: 0 8px; }
        .timeline-dot { width: 32px; height: 32px; border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; position: relative; z-index: 1; }
        .timeline-content h4 { font-size: 0.9rem; margin-bottom: 4px; }
        .timeline-content p { font-size: 0.8rem; opacity: 0.7; }

        .smartart-process { display: flex; align-items: center; justify-content: center; gap: 16px; margin-top: 32px; flex-wrap: wrap; }
        .process-step { padding: 16px 24px; border-radius: 8px; color: white; font-weight: 500; text-align: center; min-width: 120px; font-size: 14px; }
        .process-arrow { font-size: 1.5rem; color: #ccc; }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 30px;
            text-align: center;
        }

        .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 16px; margin-bottom: 8px; color: var(--text-secondary); }
        .empty-state p { color: var(--text-muted); font-size: 14px; }

        /* Loading */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .loading.active { display: flex; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading p { margin-top: 16px; color: var(--text-secondary); font-size: 14px; }

        /* Progress */
        .progress-container { margin-top: 12px; display: none; }
        .progress-container.active { display: block; }
        .progress-bar { height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 0.3s; }
        .progress-text { font-size: 12px; color: var(--text-muted); margin-top: 6px; text-align: center; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
            font-size: 14px;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 3px solid var(--success-color); }
        .toast.error { border-left: 3px solid var(--danger-color); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 420px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 { font-size: 18px; }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
        }

        .modal-close:hover { color: var(--text-primary); }

        /* Settings Button */
        .settings-btn {
            position: absolute;
            top: 0;
            right: 50px;
            width: 44px;
            height: 44px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .settings-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .slide-count-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .slide-count-row label { font-size: 13px; color: var(--text-secondary); white-space: nowrap; }
        .slide-count-row input { width: 70px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">â† è¿”å›å·¥å…·ç®±</a>

        <button class="settings-btn" onclick="openSettings()" title="API è®¾ç½®">âš™ï¸</button>

        <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜">
            <span class="icon-sun">â˜€ï¸</span>
            <span class="icon-moon">ğŸŒ™</span>
        </button>

        <h1>AIPPT - AI æ™ºèƒ½ PPT ç”Ÿæˆå™¨</h1>

        <div class="main-layout">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Input Panel -->
                <div class="panel">
                    <div class="panel-title">ğŸ“ å†…å®¹è¾“å…¥</div>

                    <div class="tabs">
                        <button class="tab active" data-mode="topic" onclick="switchMode('topic')">ä¸»é¢˜</button>
                        <button class="tab" data-mode="outline" onclick="switchMode('outline')">å¤§çº²</button>
                        <button class="tab" data-mode="content" onclick="switchMode('content')">å†…å®¹</button>
                        <button class="tab" data-mode="file" onclick="switchMode('file')">æ–‡ä»¶</button>
                    </div>

                    <div id="mode-topic" class="mode-content">
                        <div class="form-group">
                            <label>PPT ä¸»é¢˜</label>
                            <input type="text" id="topic-input" placeholder="ä¾‹å¦‚ï¼šæ–°èƒ½æºæ±½è½¦å¸‚åœºåˆ†ææŠ¥å‘Š">
                        </div>
                        <div class="slide-count-row">
                            <label>å¹»ç¯ç‰‡æ•°é‡ï¼š</label>
                            <input type="number" id="slide-count" value="10" min="5" max="30">
                        </div>
                    </div>

                    <div id="mode-outline" class="mode-content" style="display:none;">
                        <div class="form-group">
                            <label>PPT å¤§çº²ï¼ˆæ¯è¡Œä¸€ä¸ªæ ‡é¢˜ï¼‰</label>
                            <textarea id="outline-input" placeholder="å°é¢ï¼šæ–°èƒ½æºæ±½è½¦å¸‚åœºåˆ†æ&#10;å¸‚åœºæ¦‚è¿°&#10;å‘å±•ç°çŠ¶&#10;ç«äº‰æ ¼å±€&#10;æœªæ¥è¶‹åŠ¿&#10;æ€»ç»“ä¸å»ºè®®"></textarea>
                        </div>
                    </div>

                    <div id="mode-content" class="mode-content" style="display:none;">
                        <div class="form-group">
                            <label>è¯¦ç»†å†…å®¹</label>
                            <textarea id="content-input" placeholder="ç²˜è´´å®Œæ•´å†…å®¹ï¼ŒAI å°†è‡ªåŠ¨åˆ†é¡µæ’ç‰ˆ..."></textarea>
                        </div>
                    </div>

                    <div id="mode-file" class="mode-content" style="display:none;">
                        <div class="file-upload" onclick="document.getElementById('file-input').click()">
                            <div class="icon">ğŸ“„</div>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                            <span class="formats">æ”¯æŒ TXTã€Markdownã€Word æ–‡ä»¶</span>
                            <input type="file" id="file-input" accept=".txt,.md,.docx" onchange="handleFileUpload(event)">
                        </div>
                        <div id="file-preview" style="display:none; margin-top: 12px;">
                            <div class="form-group">
                                <label>æ–‡ä»¶å†…å®¹é¢„è§ˆ</label>
                                <textarea id="file-content" readonly></textarea>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="generatePPT()">âš¡ ç”Ÿæˆ PPT</button>

                    <div class="progress-container" id="progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <p class="progress-text" id="progress-text">æ­£åœ¨ç”Ÿæˆ...</p>
                    </div>
                </div>

                <!-- Style Panel -->
                <div class="panel" style="margin-top: 16px;">
                    <div class="panel-title">ğŸ¨ é£æ ¼è®¾ç½®</div>

                    <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; display: block;">é€‰æ‹©æ¨¡æ¿</label>
                    <div class="template-grid">
                        <div class="template-card active" data-template="business" onclick="selectTemplate('business')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #1e3a5f, #2d5a87);">ğŸ“Š</div>
                            <span class="name">å•†åŠ¡è“</span>
                        </div>
                        <div class="template-card" data-template="tech" onclick="selectTemplate('tech')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #4f46e5, #7c3aed);">ğŸ’»</div>
                            <span class="name">ç§‘æŠ€ç´«</span>
                        </div>
                        <div class="template-card" data-template="nature" onclick="selectTemplate('nature')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #065f46, #10b981);">ğŸŒ¿</div>
                            <span class="name">è‡ªç„¶ç»¿</span>
                        </div>
                        <div class="template-card" data-template="warm" onclick="selectTemplate('warm')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #9a3412, #f59e0b);">ğŸ”¥</div>
                            <span class="name">æš–è‰²æ©™</span>
                        </div>
                        <div class="template-card" data-template="minimal" onclick="selectTemplate('minimal')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); color: #1e293b;">âœ¨</div>
                            <span class="name">ç®€çº¦ç™½</span>
                        </div>
                        <div class="template-card" data-template="dark" onclick="selectTemplate('dark')">
                            <div class="template-preview" style="background: linear-gradient(135deg, #18181b, #3f3f46);">ğŸŒ™</div>
                            <span class="name">æš—é»‘é£</span>
                        </div>
                    </div>

                    <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; display: block;">ä¸»é¢˜è‰²</label>
                    <div class="color-grid">
                        <div class="color-option active" style="background: #6366f1;" data-color="#6366f1" onclick="selectColor('#6366f1')"></div>
                        <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6" onclick="selectColor('#3b82f6')"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor('#10b981')"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor('#f59e0b')"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectColor('#ef4444')"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor('#8b5cf6')"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor('#ec4899')"></div>
                        <div class="color-option" style="background: #14b8a6;" data-color="#14b8a6" onclick="selectColor('#14b8a6')"></div>
                    </div>
                </div>

                <!-- Export Panel -->
                <div class="panel" style="margin-top: 16px;">
                    <div class="panel-title">ğŸ“¥ å¯¼å‡º</div>
                    <div class="export-grid">
                        <button class="export-btn" onclick="exportPPTX()" id="btn-pptx" disabled>ğŸ“„ PPTX</button>
                        <button class="export-btn" onclick="exportPDF()" id="btn-pdf" disabled>ğŸ“• PDF</button>
                        <button class="export-btn" onclick="exportImages()" id="btn-images" disabled>ğŸ–¼ï¸ å›¾ç‰‡</button>
                        <button class="export-btn" onclick="exportHTML()" id="btn-html" disabled>ğŸŒ HTML</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Preview -->
            <div class="right-panel">
                <div class="panel preview-panel">
                    <div class="panel-title">ğŸ‘ï¸ é¢„è§ˆ</div>

                    <div id="empty-state" class="empty-state">
                        <div class="icon">ğŸ¬</div>
                        <h3>å¼€å§‹åˆ›å»ºæ‚¨çš„ PPT</h3>
                        <p>è¾“å…¥ä¸»é¢˜æˆ–å†…å®¹ï¼ŒAI å°†ä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šæ¼”ç¤ºæ–‡ç¨¿</p>
                    </div>

                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p id="loading-text">AI æ­£åœ¨ç”Ÿæˆå†…å®¹...</p>
                    </div>

                    <div id="slides-container" class="slides-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>API è®¾ç½®</h2>
                <button class="modal-close" onclick="closeSettings()">âœ•</button>
            </div>
            <div class="form-group">
                <label>API æä¾›å•†</label>
                <select id="api-provider" onchange="onProviderChange()">
                    <option value="88code">88code (æœ¬åœ°ä»£ç†)</option>
                    <option value="openrouter">OpenRouter (æµè§ˆå™¨ç›´è¿)</option>
                    <option value="custom">è‡ªå®šä¹‰ API</option>
                </select>
                <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;" id="provider-hint">
                    éœ€å…ˆè¿è¡Œ: node aippt-proxy.js
                </small>
            </div>
            <div class="form-group" id="api-url-group" style="display: none;">
                <label>API Base URL</label>
                <input type="text" id="api-url" placeholder="http://localhost:3456">
            </div>
            <div class="form-group" id="api-key-group">
                <label>API Key</label>
                <input type="password" id="api-key" placeholder="sk-...">
                <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;" id="api-key-hint">
                    ä½¿ç”¨ç¯å¢ƒå˜é‡ ANTHROPIC_AUTH_TOKENï¼ˆæ— éœ€å¡«å†™ï¼‰
                </small>
            </div>
            <div class="form-group">
                <label>æ¨¡å‹</label>
                <select id="api-model">
                    <optgroup label="OpenRouter æ¨¡å‹" id="openrouter-models">
                        <option value="anthropic/claude-sonnet-4">Claude Sonnet 4 (æ¨è)</option>
                        <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                        <option value="anthropic/claude-3-opus">Claude 3 Opus</option>
                        <option value="anthropic/claude-3-haiku">Claude 3 Haiku (å¿«é€Ÿ)</option>
                        <option value="openai/gpt-4o">GPT-4o</option>
                        <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                    </optgroup>
                    <optgroup label="è‡ªå®šä¹‰ API æ¨¡å‹" id="custom-models" style="display: none;">
                        <option value="claude-sonnet-4-5-20250514">Claude Sonnet 4.5</option>
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                        <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                    </optgroup>
                </select>
            </div>
            <button class="btn btn-primary btn-block" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"><span id="toast-message"></span></div>

    <script>
        // Global state
        let currentMode = 'topic';
        let currentTemplate = 'business';
        let currentColor = '#6366f1';
        let slidesData = [];
        let charts = [];

        // Templates
        const templates = {
            business: { bgColor: '#ffffff', titleBg: 'linear-gradient(135deg, #1e3a5f, #2d5a87)', accentColor: '#1e3a5f', textColor: '#1a1a2e' },
            tech: { bgColor: '#0f172a', titleBg: 'linear-gradient(135deg, #4f46e5, #7c3aed)', accentColor: '#6366f1', textColor: '#f1f5f9' },
            nature: { bgColor: '#ffffff', titleBg: 'linear-gradient(135deg, #065f46, #10b981)', accentColor: '#059669', textColor: '#1a1a2e' },
            warm: { bgColor: '#fffbeb', titleBg: 'linear-gradient(135deg, #9a3412, #f59e0b)', accentColor: '#d97706', textColor: '#1a1a2e' },
            minimal: { bgColor: '#ffffff', titleBg: 'linear-gradient(135deg, #f8fafc, #e2e8f0)', accentColor: '#64748b', textColor: '#1e293b' },
            dark: { bgColor: '#18181b', titleBg: 'linear-gradient(135deg, #27272a, #3f3f46)', accentColor: '#a1a1aa', textColor: '#fafafa' }
        };

        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        });

        // Settings
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('aippt-settings') || '{}');
            const provider = settings.provider || '88code';
            document.getElementById('api-provider').value = provider;
            document.getElementById('api-url').value = settings.apiUrl || '';
            document.getElementById('api-key').value = settings.apiKey || '';
            document.getElementById('api-model').value = settings.model || 'claude-sonnet-4-5-20250514';
            onProviderChange();
        }

        function onProviderChange() {
            const provider = document.getElementById('api-provider').value;
            const urlGroup = document.getElementById('api-url-group');
            const keyGroup = document.getElementById('api-key-group');
            const keyHint = document.getElementById('api-key-hint');
            const providerHint = document.getElementById('provider-hint');
            const openrouterModels = document.getElementById('openrouter-models');
            const customModels = document.getElementById('custom-models');
            const modelSelect = document.getElementById('api-model');

            if (provider === '88code') {
                urlGroup.style.display = 'none';
                keyGroup.style.display = 'none';
                providerHint.innerHTML = 'é€šè¿‡ Replit æœåŠ¡å™¨è¿æ¥ 88code';
                openrouterModels.style.display = 'none';
                customModels.style.display = '';
                if (modelSelect.value.includes('/')) {
                    modelSelect.value = 'claude-sonnet-4-5-20250514';
                }
            } else if (provider === 'openrouter') {
                urlGroup.style.display = 'none';
                keyGroup.style.display = 'block';
                keyHint.innerHTML = 'åœ¨ <a href="https://openrouter.ai/keys" target="_blank" style="color: var(--accent-color);">openrouter.ai/keys</a> è·å– API Key';
                providerHint.innerHTML = 'æ”¯æŒ CORSï¼Œå¯ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨';
                openrouterModels.style.display = '';
                customModels.style.display = 'none';
                if (!modelSelect.value.includes('/')) {
                    modelSelect.value = 'anthropic/claude-sonnet-4';
                }
            } else {
                urlGroup.style.display = 'block';
                keyGroup.style.display = 'block';
                keyHint.innerHTML = 'å¡«å†™è‡ªå®šä¹‰ API çš„å¯†é’¥';
                providerHint.innerHTML = 'è‡ªå®šä¹‰ API ç«¯ç‚¹';
                openrouterModels.style.display = 'none';
                customModels.style.display = '';
                if (modelSelect.value.includes('/')) {
                    modelSelect.value = 'claude-sonnet-4-5-20250514';
                }
            }
        }

        function saveSettings() {
            const settings = {
                provider: document.getElementById('api-provider').value,
                apiUrl: document.getElementById('api-url').value,
                apiKey: document.getElementById('api-key').value,
                model: document.getElementById('api-model').value
            };
            localStorage.setItem('aippt-settings', JSON.stringify(settings));
            closeSettings();
            showToast('è®¾ç½®å·²ä¿å­˜', 'success');
        }

        function openSettings() { document.getElementById('settings-modal').classList.add('active'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }

        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeSettings();
        });

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.toggle('active', tab.dataset.mode === mode));
            document.querySelectorAll('.mode-content').forEach(c => c.style.display = 'none');
            document.getElementById(`mode-${mode}`).style.display = 'block';
        }

        // Template & Color selection
        function selectTemplate(template) {
            currentTemplate = template;
            document.querySelectorAll('.template-card').forEach(c => c.classList.toggle('active', c.dataset.template === template));
            if (slidesData.length > 0) renderSlides();
        }

        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-option').forEach(c => c.classList.toggle('active', c.dataset.color === color));
            if (slidesData.length > 0) renderSlides();
        }

        // File upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                let content = '';
                if (file.name.endsWith('.docx')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    content = result.value;
                } else {
                    content = await file.text();
                }

                document.getElementById('file-content').value = content;
                document.getElementById('file-preview').style.display = 'block';
                showToast('æ–‡ä»¶å·²åŠ è½½', 'success');
            } catch (error) {
                showToast('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            }
        }

        // Generate PPT
        async function generatePPT() {
            const settings = JSON.parse(localStorage.getItem('aippt-settings') || '{}');
            // 88code æ¨¡å¼ä¸éœ€è¦ API Key
            if (settings.provider !== '88code' && !settings.apiKey) {
                openSettings();
                showToast('è¯·å…ˆé…ç½® API Key', 'error');
                return;
            }

            let inputContent = '';
            let promptType = '';

            switch (currentMode) {
                case 'topic':
                    inputContent = document.getElementById('topic-input').value;
                    promptType = 'topic';
                    break;
                case 'outline':
                    inputContent = document.getElementById('outline-input').value;
                    promptType = 'outline';
                    break;
                case 'content':
                    inputContent = document.getElementById('content-input').value;
                    promptType = 'content';
                    break;
                case 'file':
                    inputContent = document.getElementById('file-content').value;
                    promptType = 'content';
                    break;
            }

            if (!inputContent.trim()) {
                showToast('è¯·è¾“å…¥å†…å®¹', 'error');
                return;
            }

            showLoading(true);
            updateProgress(10, 'AI æ­£åœ¨åˆ†æå†…å®¹...');

            try {
                const slideCount = document.getElementById('slide-count')?.value || 10;
                const prompt = buildPrompt(promptType, inputContent, slideCount);

                updateProgress(30, 'AI æ­£åœ¨ç”Ÿæˆå¹»ç¯ç‰‡...');
                const response = await callAPI(settings, prompt);

                updateProgress(70, 'æ­£åœ¨è§£æç»“æœ...');
                slidesData = parseResponse(response);

                updateProgress(90, 'æ­£åœ¨æ¸²æŸ“é¢„è§ˆ...');
                renderSlides();
                enableExportButtons();

                updateProgress(100, 'å®Œæˆ!');
                setTimeout(() => showLoading(false), 500);
                showToast(`æˆåŠŸç”Ÿæˆ ${slidesData.length} é¡µå¹»ç¯ç‰‡`, 'success');
            } catch (error) {
                console.error('Generation error:', error);
                showLoading(false);
                showToast('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        function buildPrompt(type, content, slideCount) {
            return `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„PPTå†…å®¹ç”Ÿæˆä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„${type === 'topic' ? 'ä¸»é¢˜' : type === 'outline' ? 'å¤§çº²' : 'å†…å®¹'}ï¼Œç”Ÿæˆä¸€ä»½ä¸“ä¸šçš„PPTç»“æ„ã€‚

è¦æ±‚ï¼š
1. ç”Ÿæˆçº¦ ${slideCount} é¡µå¹»ç¯ç‰‡
2. åŒ…å«å°é¢é¡µã€ç›®å½•é¡µã€å†…å®¹é¡µå’Œç»“æŸé¡µ
3. å†…å®¹é¡µç±»å‹åŒ…æ‹¬ï¼šæ™®é€šæ–‡å­—é¡µã€å›¾è¡¨é¡µï¼ˆæŸ±çŠ¶å›¾/é¥¼å›¾/æŠ˜çº¿å›¾ï¼‰ã€è¡¨æ ¼é¡µã€æ—¶é—´çº¿é¡µã€æµç¨‹å›¾é¡µ
4. æ¯é¡µå†…å®¹ç²¾ç‚¼ï¼Œæ¯ä¸ªè¦ç‚¹ä¸è¶…è¿‡20å­—
5. å›¾è¡¨æ•°æ®è¦åˆç†çœŸå®

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ï¼š

{
  "title": "PPTæ ‡é¢˜",
  "slides": [
    {"type": "cover", "title": "ä¸»æ ‡é¢˜", "subtitle": "å‰¯æ ‡é¢˜"},
    {"type": "toc", "title": "ç›®å½•", "items": ["ç« èŠ‚1", "ç« èŠ‚2"]},
    {"type": "content", "title": "é¡µé¢æ ‡é¢˜", "points": ["è¦ç‚¹1", "è¦ç‚¹2", "è¦ç‚¹3"]},
    {"type": "chart", "title": "å›¾è¡¨æ ‡é¢˜", "chartType": "bar", "data": {"labels": ["A", "B", "C"], "values": [30, 50, 20], "label": "æ•°æ®"}},
    {"type": "table", "title": "è¡¨æ ¼æ ‡é¢˜", "headers": ["åˆ—1", "åˆ—2"], "rows": [["æ•°æ®1", "æ•°æ®2"]]},
    {"type": "timeline", "title": "æ—¶é—´çº¿", "events": [{"time": "2020", "title": "äº‹ä»¶1", "desc": "æè¿°"}]},
    {"type": "process", "title": "æµç¨‹", "steps": ["æ­¥éª¤1", "æ­¥éª¤2", "æ­¥éª¤3"]},
    {"type": "end", "title": "è°¢è°¢è§‚çœ‹", "subtitle": ""}
  ]
}

ç”¨æˆ·è¾“å…¥çš„${type === 'topic' ? 'ä¸»é¢˜' : type === 'outline' ? 'å¤§çº²' : 'å†…å®¹'}ï¼š
${content}`;
        }

        async function callAPI(settings, prompt) {
            const provider = settings.provider || '88code';

            if (provider === '88code') {
                // 88code é€šè¿‡ Replit ä»£ç†
                const response = await fetch('https://tools--hjx819779331.replit.app/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: settings.model || 'claude-sonnet-4-5-20250514',
                        max_tokens: 8192,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('88code Error:', errorText);
                    if (response.status === 0 || errorText.includes('Failed to fetch')) {
                        throw new Error('æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¨åé‡è¯•');
                    }
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                if (data.content && data.content[0]) {
                    return data.content[0].text;
                }
                throw new Error('æ— æ³•è§£æ API å“åº”');

            } else if (provider === 'openrouter') {
                // OpenRouter API (OpenAI å…¼å®¹æ ¼å¼ï¼Œæ”¯æŒ CORS)
                if (!settings.apiKey || !settings.apiKey.trim()) {
                    throw new Error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® OpenRouter API Key');
                }

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'AIPPT Generator'
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        max_tokens: 8192,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('OpenRouter Error:', errorData);
                    throw new Error(errorData.error?.message || `API è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0]) {
                    return data.choices[0].message.content;
                }
                throw new Error('æ— æ³•è§£æ API å“åº”');

            } else {
                // è‡ªå®šä¹‰ API (Anthropic æ ¼å¼)
                const headers = { 'Content-Type': 'application/json' };
                if (settings.apiKey && settings.apiKey.trim()) {
                    headers['x-api-key'] = settings.apiKey;
                }

                const apiUrl = settings.apiUrl || 'https://api.anthropic.com';
                const response = await fetch(`${apiUrl}/v1/messages`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        model: settings.model,
                        max_tokens: 8192,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();

                // Anthropic æ ¼å¼è¿”å›
                if (data.content && data.content[0]) {
                    return data.content[0].text;
                }
                // OpenAI æ ¼å¼è¿”å›
                if (data.choices && data.choices[0]) {
                    return data.choices[0].message.content;
                }

                throw new Error('æ— æ³•è§£æ API å“åº”');
            }
        }

        function parseResponse(response) {
            console.log('Raw response:', response);

            // å°è¯•æ‰¾åˆ° JSON å¯¹è±¡
            const jsonMatch = response.match(/\{[\s\S]*"slides"[\s\S]*\}/);
            if (jsonMatch) {
                try {
                    const data = JSON.parse(jsonMatch[0]);
                    if (data.slides && Array.isArray(data.slides)) {
                        console.log('Parsed slides:', data.slides.length);
                        return data.slides;
                    }
                } catch (e) {
                    console.error('JSON parse error:', e);
                }
            }

            // å°è¯•æ‰¾åˆ° slides æ•°ç»„
            const slidesMatch = response.match(/\[[\s\S]*\{[\s\S]*"type"[\s\S]*\}[\s\S]*\]/);
            if (slidesMatch) {
                try {
                    const slides = JSON.parse(slidesMatch[0]);
                    if (Array.isArray(slides)) {
                        console.log('Parsed slides array:', slides.length);
                        return slides;
                    }
                } catch (e) {
                    console.error('Slides array parse error:', e);
                }
            }

            console.error('Cannot parse response:', response.substring(0, 500));
            throw new Error('AI è¿”å›æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•');
        }

        // Render slides
        function renderSlides() {
            const container = document.getElementById('slides-container');
            const emptyState = document.getElementById('empty-state');

            charts.forEach(chart => chart.destroy());
            charts = [];
            container.innerHTML = '';
            emptyState.style.display = 'none';

            const template = templates[currentTemplate];
            const accent = currentColor;

            slidesData.forEach((slide, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'slide-wrapper';
                wrapper.id = `slide-${index}`;

                const number = document.createElement('div');
                number.className = 'slide-number';
                number.textContent = `${index + 1} / ${slidesData.length}`;

                const slideEl = document.createElement('div');
                slideEl.className = 'slide';
                slideEl.style.background = template.bgColor;

                const content = document.createElement('div');
                content.className = 'slide-content';
                content.style.color = template.textColor;

                switch (slide.type) {
                    case 'cover':
                    case 'end':
                        content.classList.add('slide-cover');
                        content.style.background = template.titleBg;
                        content.style.color = '#ffffff';
                        content.innerHTML = `<h1>${slide.title || ''}</h1><p class="subtitle">${slide.subtitle || ''}</p>`;
                        break;

                    case 'toc':
                        content.classList.add('slide-content-page');
                        content.innerHTML = `<h2 style="border-color: ${accent}">${slide.title || 'ç›®å½•'}</h2>
                            <div class="points">${(slide.items || []).map((item, i) => `
                                <div class="point"><div class="point-icon" style="background: ${accent}">${i + 1}</div><span>${item}</span></div>
                            `).join('')}</div>`;
                        break;

                    case 'content':
                        content.classList.add('slide-content-page');
                        content.innerHTML = `<h2 style="border-color: ${accent}">${slide.title || ''}</h2>
                            <div class="points">${(slide.points || []).map(point => `
                                <div class="point"><div class="point-icon" style="background: ${accent}">âœ“</div><span>${point}</span></div>
                            `).join('')}</div>`;
                        break;

                    case 'chart':
                        const canvasId = `chart-${index}`;
                        content.classList.add('slide-chart');
                        content.innerHTML = `<h2 style="border-bottom: 3px solid ${accent}; padding-bottom: 12px;">${slide.title || ''}</h2>
                            <div class="chart-container"><canvas id="${canvasId}"></canvas></div>`;
                        slideEl.appendChild(content);
                        wrapper.appendChild(number);
                        wrapper.appendChild(slideEl);
                        container.appendChild(wrapper);
                        setTimeout(() => renderChart(canvasId, slide.chartType, slide.data, accent), 100);
                        return;

                    case 'table':
                        content.classList.add('slide-table');
                        content.innerHTML = `<h2 style="border-bottom: 3px solid ${accent}; padding-bottom: 12px;">${slide.title || ''}</h2>
                            <table><thead><tr style="background: ${accent}; color: white;">
                                ${(slide.headers || []).map(h => `<th>${h}</th>`).join('')}
                            </tr></thead><tbody>
                                ${(slide.rows || []).map((row, i) => `<tr style="background: ${i % 2 === 0 ? 'transparent' : 'rgba(0,0,0,0.03)'}">
                                    ${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
                            </tbody></table>`;
                        break;

                    case 'timeline':
                        content.innerHTML = `<h2 style="border-bottom: 3px solid ${accent}; padding-bottom: 12px;">${slide.title || ''}</h2>
                            <div class="timeline">${(slide.events || []).map(event => `
                                <div class="timeline-item">
                                    <div class="timeline-dot" style="background: ${accent}">${event.time}</div>
                                    <div class="timeline-content"><h4>${event.title}</h4><p>${event.desc || ''}</p></div>
                                </div>`).join('')}</div>`;
                        break;

                    case 'process':
                        content.innerHTML = `<h2 style="border-bottom: 3px solid ${accent}; padding-bottom: 12px;">${slide.title || ''}</h2>
                            <div class="smartart-process">${(slide.steps || []).map((step, i) => `
                                ${i > 0 ? '<span class="process-arrow">â†’</span>' : ''}
                                <div class="process-step" style="background: ${accent}">${step}</div>`).join('')}</div>`;
                        break;
                }

                slideEl.appendChild(content);
                wrapper.appendChild(number);
                wrapper.appendChild(slideEl);
                container.appendChild(wrapper);
            });
        }

        function renderChart(canvasId, chartType, data, accent) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const colors = [accent, adjustColor(accent, 30), adjustColor(accent, -30), adjustColor(accent, 60), adjustColor(accent, -60)];

            const chart = new Chart(canvas.getContext('2d'), {
                type: chartType === 'pie' ? 'pie' : chartType === 'line' ? 'line' : 'bar',
                data: {
                    labels: data?.labels || [],
                    datasets: [{
                        label: data?.label || 'æ•°æ®',
                        data: data?.values || [],
                        backgroundColor: chartType === 'pie' ? colors : accent,
                        borderColor: chartType === 'line' ? accent : 'transparent',
                        borderWidth: chartType === 'line' ? 3 : 0,
                        fill: false,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: chartType === 'pie' ? 'right' : 'top' } },
                    scales: chartType === 'pie' ? {} : { y: { beginAtZero: true } }
                }
            });
            charts.push(chart);
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
            const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
            const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        // Export functions
        function enableExportButtons() {
            ['btn-pptx', 'btn-pdf', 'btn-images', 'btn-html'].forEach(id => document.getElementById(id).disabled = false);
        }

        async function exportPPTX() {
            showToast('æ­£åœ¨ç”Ÿæˆ PPTX...', 'success');
            const pptx = new PptxGenJS();
            const template = templates[currentTemplate];
            const accent = currentColor;

            pptx.layout = 'LAYOUT_16x9';

            for (const slide of slidesData) {
                const pptSlide = pptx.addSlide();

                if (slide.type === 'cover' || slide.type === 'end') {
                    pptSlide.background = { color: accent.replace('#', '') };
                    pptSlide.addText(slide.title || '', { x: 0.5, y: '40%', w: '90%', h: 1, fontSize: 44, bold: true, color: 'FFFFFF', align: 'center' });
                    pptSlide.addText(slide.subtitle || '', { x: 0.5, y: '55%', w: '90%', h: 0.5, fontSize: 24, color: 'FFFFFF', align: 'center' });
                } else {
                    pptSlide.background = { color: template.bgColor.replace('#', '') };
                    pptSlide.addText(slide.title || '', { x: 0.5, y: 0.3, w: '90%', h: 0.8, fontSize: 32, bold: true, color: template.textColor.replace('#', '') });

                    const items = slide.items || slide.points || [];
                    items.forEach((item, i) => {
                        pptSlide.addText(item, { x: 0.8, y: 1.5 + i * 0.7, w: '85%', h: 0.5, fontSize: 20, color: template.textColor.replace('#', ''), bullet: true });
                    });
                }
            }

            await pptx.writeFile({ fileName: `${slidesData[0]?.title || 'presentation'}.pptx` });
            showToast('PPTX å¯¼å‡ºæˆåŠŸ!', 'success');
        }

        async function exportPDF() {
            showToast('æ­£åœ¨ç”Ÿæˆ PDF...', 'success');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('landscape', 'mm', 'a4');
            const slides = document.querySelectorAll('.slide');

            for (let i = 0; i < slides.length; i++) {
                if (i > 0) pdf.addPage();
                const canvas = await html2canvas(slides[i], { scale: 2, useCORS: true });
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 297, 167);
            }

            pdf.save(`${slidesData[0]?.title || 'presentation'}.pdf`);
            showToast('PDF å¯¼å‡ºæˆåŠŸ!', 'success');
        }

        async function exportImages() {
            showToast('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...', 'success');
            const slides = document.querySelectorAll('.slide');

            for (let i = 0; i < slides.length; i++) {
                const canvas = await html2canvas(slides[i], { scale: 2, useCORS: true });
                const link = document.createElement('a');
                link.download = `slide-${i + 1}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                await new Promise(r => setTimeout(r, 500));
            }
            showToast('å›¾ç‰‡å¯¼å‡ºæˆåŠŸ!', 'success');
        }

        function exportHTML() {
            const template = templates[currentTemplate];
            const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${slidesData[0]?.title || 'Presentation'}</title>
<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:sans-serif;background:#1a1a2e;padding:40px}
.slides-container{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:40px}
.slide{width:100%;aspect-ratio:16/9;background:${template.bgColor};border-radius:8px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.slide-content{width:100%;height:100%;padding:32px 40px;color:${template.textColor};display:flex;flex-direction:column}
.slide-cover{justify-content:center;align-items:center;text-align:center;background:${template.titleBg};color:white}
h1{font-size:2.2rem;margin-bottom:12px}h2{font-size:1.5rem;margin-bottom:24px;padding-bottom:12px;border-bottom:3px solid ${currentColor}}
.points{flex:1;display:flex;flex-direction:column;justify-content:center;gap:12px}
.point{display:flex;align-items:center;gap:12px;font-size:1rem}</style></head>
<body><div class="slides-container">${document.getElementById('slides-container').innerHTML}</div></body></html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const link = document.createElement('a');
            link.download = `${slidesData[0]?.title || 'presentation'}.html`;
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast('HTML å¯¼å‡ºæˆåŠŸ!', 'success');
        }

        // UI helpers
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
            document.getElementById('empty-state').style.display = show ? 'none' : (slidesData.length ? 'none' : 'flex');
            document.getElementById('progress').classList.toggle('active', show);
        }

        function updateProgress(percent, text) {
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = text;
            document.getElementById('loading-text').textContent = text;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = `toast ${type}`;
            document.getElementById('toast-message').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Init
        loadSettings();
    </script>
</body>
</html>
